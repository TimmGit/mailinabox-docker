postfix:
  build: postfix
  env_file: .env
  volumes:
    - data/ssl:/home/data/ssl
    - data/mail:/home/data/mail
    - /tmp/syslogdev:/dev
  links:
    - syslog
    - postgrey
    - dovecot
    - spamassassin
  ports:
    - "25:25"
    - "587:587"

postgrey:
  build: postgrey
  volumes:
    - /tmp/syslogdev/log:/dev/log

dovecot:
  build: dovecot
  environment:
    # FIXME Find a way to get this working with links instead
    SPAMASSASSIN_1_PORT_10025_TCP_ADDR: 172.17.42.1
  env_file:
    - .doveadm_password
  volumes:
    - data/ssl:/home/data/ssl
    - data/mail:/home/data/mail
    - /tmp/syslogdev/log:/dev/log
    ## FIXME Don't do this
    #- data/dovecot-run:/var/run/dovecot
  links:
    - syslog
    # FIXME Find a way to get this working with links instead
    #- spamassassin
  ports:
    - "993:993"

spamassassin:
  build: spamassassin
  volumes:
    - data/mail/spamassassin:/home/data/mail/spamassassin
    - /tmp/syslogdev/log:/dev/log
  links:
    - syslog
    - dovecot
  # Make it accessible for spamc from dovecot
  # FIXME Find a way to get this working with links instead
  ports:
    - "172.17.42.1:10025:10025"

management:
  build: management
  environment:
    DEBUG: 1
  env_file: .doveadm_password
  volumes:
    - data/mail:/home/data/mail
    - data/mailinabox:/var/lib/mailinabox
    - data/ssl:/home/data/ssl
    - /tmp/syslogdev/log:/dev/log
    ## FIXME Don't do this
    #- data/dovecot-run:/var/run/dovecot
  links:
    - syslog
    - dovecot
  ports:
    # FIXME Remove when reverse proxy is there
    - "10222:10222"

syslog:
  build: syslog
  env_file: .env
  volumes:
    - /tmp/syslogdev:/dev
    - log:/var/log

setup:
  build: setup
  env_file: .env
  volumes:
    - data/ssl:/home/data/ssl
    - data/mailinabox:/var/lib/mailinabox
  links:
    - syslog
    - management
  command: /bin/true
